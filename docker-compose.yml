version: '3'

services:
    sourcedb:
        build: ./sourcedb-docker
        restart: unless-stopped
        ports:
            - "3307:3306"
        volumes:
            - ./sourcedb-etc:/root/.ssh
        command: [ "ssh", "-NL", "0.0.0.0:3306:${SOURCE_DB_HOST:-localhost}:${SOURCE_DB_PORT:-3306}", "${SOURCE_DB_PROXY_HOST}" ]
    db:
        image: mysql:8.0.21
        depends_on:
            - sourcedb
        restart: unless-stopped
        env_file: mysql.env
        ports:
            - "3306:3306"
        volumes:
            - ./db-etc:/etc/mysql/conf.d
            - db-var:/var/lib/mysql
            - db-log:/var/log/mysql
        cap_add:
            - SYS_NICE
    api:
        depends_on:
            - db
        build: ./api-docker
        restart: unless-stopped
        env_file: api.env
        volumes:
            - ./api:/api
    nginx:
        depends_on:
            - api
        image: nginx:1.19.2-alpine-perl
        restart: unless-stopped
        ports:
            - "${HTTP_PORT:-80}:80"
            - "${HTTPS_PORT:-443}:443"
        volumes:
            - ./nginx-etc:/etc/nginx/conf.d
            - ./letsencrypt-etc:/etc/letsencrypt
            - ./www:/var/www
            - nginx-log:/var/log/nginx/
volumes:
    db-var:
    db-log:
    nginx-log:
